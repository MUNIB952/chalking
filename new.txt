service-worker.js:39 Service Worker: Intercepting request to https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:44 Service Worker: Proxying to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:71 Service Worker: POST request to proxy has Content-Type: application/json
service-worker.js:100 Service Worker: Successfully proxied request to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent, Status: 200
service-worker.js:39 Service Worker: Intercepting request to https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:44 Service Worker: Proxying to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:71 Service Worker: POST request to proxy has Content-Type: application/json
service-worker.js:100 Service Worker: Successfully proxied request to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent, Status: 200
(index):64 cdn.tailwindcss.com should not be used in production. To use Tailwind CSS in production, install it as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation
(anonymous) @ (index):64
websocket-interceptor.js:64 [WebSocketInterceptor-Proxy] Global WebSocket constructor has been wrapped using Proxy.
/index.tsx:1  Failed to load resource: the server responded with a status of 404 ()
(index):34 Service Worker registered successfully with scope: https://ai-drawing-assistant-57166504219.us-west1.run.app/
service-worker.js:39 Service Worker: Intercepting request to https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:44 Service Worker: Proxying to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent
service-worker.js:71 Service Worker: POST request to proxy has Content-Type: application/json
service-worker.js:100 Service Worker: Successfully proxied request to https://ai-drawing-assistant-57166504219.us-west1.run.app/api-proxy/v1beta/models/gemini-2.5-flash:generateContent, Status: 200
data:application/javascript;base64,aW1wb3J0IHsganN4IGFzIF9qc3gsIGpzeHMgYXMgX2pzeHMgfSBmcm9tICJyZWFjdC9qc3gtcnVudGltZSI7CmltcG9ydCB7IHVzZVN0YXRlLCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7CmltcG9ydCB7IENhbnZhcyB9IGZyb20gJ0AvY29tcG9uZW50cy9DYW52YXMnOwppbXBvcnQgeyBDb250cm9scyB9IGZyb20gJ0AvY29tcG9uZW50cy9Db250cm9scyc7CmltcG9ydCB7IGdldEluaXRpYWxQbGFuLCBnZW5lcmF0ZVNwZWVjaCB9IGZyb20gJ0Avc2VydmljZXMvZ2VtaW5pU2VydmljZSc7CmltcG9ydCB7IE1haWxJY29uLCBHaXRodWJJY29uLCBMb2dvSWNvbiB9IGZyb20gJ0AvY29tcG9uZW50cy9pY29ucyc7Ci8vIFRoaXMgaXMgdGhlIGNvZGUgdGhhdCB3aWxsIHJ1biBpbiB0aGUgYmFja2dyb3VuZCB0aHJlYWQgdG8gYXZvaWQgYmxvY2tpbmcgdGhlIFVJLgpjb25zdCBhdWRpb1dvcmtlckNvZGUgPSBgCiAgLy8gVGhpcyBkZWNvZGUgZnVuY3Rpb24gbm93IGxpdmVzIGluc2lkZSB0aGUgd29ya2VyLCBvZmYgdGhlIG1haW4gdGhyZWFkLgogIGZ1bmN0aW9uIGRlY29kZShiYXNlNjQpIHsKICAgIGNvbnN0IGJpbmFyeVN0cmluZyA9IGF0b2IoYmFzZTY0KTsKICAgIGNvbnN0IGxlbiA9IGJpbmFyeVN0cmluZy5sZW5ndGg7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGJ5dGVzW2ldID0gYmluYXJ5U3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQoKICBzZWxmLm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICBjb25zdCB7IGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlLCBudW1DaGFubmVscywgaW5kZXggfSA9IGUuZGF0YTsKICAgIAogICAgLy8gMS4gRGVjb2RlIHRoZSBiYXNlNjQgc3RyaW5nIHRvIGEgVWludDhBcnJheSAodGhlIGJsb2NraW5nIHBhcnQpCiAgICBjb25zdCBhdWRpb0RhdGEgPSBkZWNvZGUoYmFzZTY0QXVkaW8pOwogICAgCiAgICAvLyAyLiBQcm9jZXNzIHRoZSByYXcgYXVkaW8gZGF0YSBpbnRvIGZsb2F0IGNoYW5uZWxzCiAgICBjb25zdCBkYXRhSW50MTYgPSBuZXcgSW50MTZBcnJheShhdWRpb0RhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGZyYW1lQ291bnQgPSBkYXRhSW50MTYubGVuZ3RoIC8gbnVtQ2hhbm5lbHM7CiAgICAKICAgIGNvbnN0IGNoYW5uZWxzID0gW107CiAgICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IG51bUNoYW5uZWxzOyBjaGFubmVsKyspIHsKICAgICAgY29uc3QgY2hhbm5lbERhdGEgPSBuZXcgRmxvYXQzMkFycmF5KGZyYW1lQ291bnQpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lQ291bnQ7IGkrKykgewogICAgICAgIGNoYW5uZWxEYXRhW2ldID0gZGF0YUludDE2W2kgKiBudW1DaGFubmVscyArIGNoYW5uZWxdIC8gMzI3NjguMDsKICAgICAgfQogICAgICBjaGFubmVscy5wdXNoKGNoYW5uZWxEYXRhKTsKICAgIH0KCiAgICAvLyAzLiBTZW5kIHRoZSBwcm9jZXNzZWQgZGF0YSBiYWNrIHRvIHRoZSBtYWluIHRocmVhZCBmb3IgZmFzdCBidWZmZXIgY3JlYXRpb24uCiAgICBzZWxmLnBvc3RNZXNzYWdlKHsgY2hhbm5lbHMsIGZyYW1lQ291bnQsIHNhbXBsZVJhdGUsIGluZGV4IH0sIGNoYW5uZWxzLm1hcChjID0+IGMuYnVmZmVyKSk7CiAgfTsKYDsKY29uc3QgVEhJTktJTkdfTUVTU0FHRVMgPSBbCiAgICAnQ29uY2VwdHVhbGl6aW5nIHRoZSB2aXN1YWwgc3RvcnkuLi4nLAogICAgJ0NvbnN1bHRpbmcgbXkgaW50ZXJuYWwga25vd2xlZGdlIGJhc2UuLi4nLAogICAgJ0JyZWFraW5nIHRoZSB0b3BpYyBpbnRvIGRpZ2VzdGlibGUgc3RlcHMuLi4nLAogICAgJ1RoaXMgaXMgYSBjcmVhdGl2ZSBvbmUhIEJyYWluc3Rvcm1pbmcgbWlnaHQgdGFrZSBhIG1vbWVudC4uLicsCiAgICAnU2tldGNoaW5nIG91dCB0aGUgbmFycmF0aXZlIGFyYy4uLicsCiAgICAnUGxhbm5pbmcgdGhlIG9wdGltYWwgdmlzdWFsIGZsb3cuLi4nLApdOwpjb25zdCBQUkVQQVJJTkdfTUVTU0FHRVMgPSBbCiAgICAnV2FybWluZyB1cCBteSB2aXJ0dWFsIGRyYXdpbmcgaGFuZC4uLicsCiAgICAnQ2hvcmVvZ3JhcGhpbmcgdGhlIGFuaW1hdGlvbiBzZXF1ZW5jZS4uLicsCiAgICAnUHJlcGFyaW5nIHRoZSBjYW52YXMuLi4nLAogICAgJ0ZpbmFsaXppbmcgdGhlIGxlc3NvbiBwbGFuLi4uJywKXTsKY29uc3QgQXBwID0gKCkgPT4gewogICAgY29uc3QgW3N0YXR1cywgc2V0U3RhdHVzXSA9IHVzZVN0YXRlKCdJRExFJyk7CiAgICBjb25zdCBbZXhwbGFuYXRpb24sIHNldEV4cGxhbmF0aW9uXSA9IHVzZVN0YXRlKCdFbnRlciBhIHByb21wdCBhbmQgSVwnbGwgY3JlYXRlIGEgdm9pY2UtbGVkIHZpc3VhbCBleHBsYW5hdGlvbiBmb3IgeW91LicpOwogICAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZShudWxsKTsKICAgIGNvbnN0IFt3aGl0ZWJvYXJkU3RlcHMsIHNldFdoaXRlYm9hcmRTdGVwc10gPSB1c2VTdGF0ZShbXSk7CiAgICBjb25zdCBbY3VycmVudFN0ZXBJbmRleCwgc2V0Q3VycmVudFN0ZXBJbmRleF0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtjYW52YXNLZXksIHNldENhbnZhc0tleV0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtpc1BhdXNlZCwgc2V0SXNQYXVzZWRdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgLy8gLS0tIEF1ZGlvICYgQW5pbWF0aW9uIEVuZ2luZSBSZWZzIC0tLQogICAgY29uc3QgYXVkaW9Db250ZXh0UmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3QgYXVkaW9Xb3JrZXJSZWYgPSB1c2VSZWYobnVsbCk7CiAgICBjb25zdCBhdWRpb1NvdXJjZVJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGF1ZGlvQnVmZmVyc1JlZiA9IHVzZVJlZihbXSk7CiAgICBjb25zdCBzdGVwVGltZW91dFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGFuaW1hdGlvbkZyYW1lUmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3Qgb3ZlcmFsbEV4cGxhbmF0aW9uUmVmID0gdXNlUmVmKCcnKTsKICAgIGNvbnN0IHBsYXliYWNrT2Zmc2V0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3Qgc3RhcnRlZEF0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3QgW2FuaW1hdGlvblByb2dyZXNzLCBzZXRBbmltYXRpb25Qcm9ncmVzc10gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IHN0b3BFdmVyeXRoaW5nID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RlcFRpbWVvdXRSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7IC8qIGlnbm9yZSAqLyB9CiAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzZXRJc1BhdXNlZChmYWxzZSk7CiAgICAgICAgcGxheWJhY2tPZmZzZXRSZWYuY3VycmVudCA9IDA7CiAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICB9LCBbXSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBhdWRpb0NvbnRleHRSZWYuY3VycmVudCA9IG5ldyAod2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0KSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2F1ZGlvV29ya2VyQ29kZV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnIH0pOwogICAgICAgIGNvbnN0IHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CiAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudCA9IHdvcmtlcjsKICAgICAgICB3b3JrZXIub25tZXNzYWdlID0gKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgeyBjaGFubmVscywgZnJhbWVDb3VudCwgc2FtcGxlUmF0ZSwgaW5kZXggfSA9IGUuZGF0YTsKICAgICAgICAgICAgaWYgKCFhdWRpb0NvbnRleHRSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhdWRpb0NvbnRleHRSZWYuY3VycmVudC5jcmVhdGVCdWZmZXIoY2hhbm5lbHMubGVuZ3RoLCBmcmFtZUNvdW50LCBzYW1wbGVSYXRlKTsKICAgICAgICAgICAgY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbERhdGEsIGkpID0+IHsKICAgICAgICAgICAgICAgIGF1ZGlvQnVmZmVyLmdldENoYW5uZWxEYXRhKGkpLnNldChjaGFubmVsRGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtpbmRleF0gPSBhdWRpb0J1ZmZlcjsKICAgICAgICB9OwogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIHdvcmtlci50ZXJtaW5hdGUoKTsKICAgICAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICAgICAgYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQ/LmNsb3NlKCk7CiAgICAgICAgfTsKICAgIH0sIFtzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gdXNlQ2FsbGJhY2soYXN5bmMgKHByb21wdCkgPT4gewogICAgICAgIGlmICghcHJvbXB0LnRyaW0oKSB8fCBzdGF0dXMgPT09ICdUSElOS0lORycgfHwgc3RhdHVzID09PSAnUFJFUEFSSU5HJykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudD8uc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB7CiAgICAgICAgICAgIGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LnJlc3VtZSgpOwogICAgICAgIH0KICAgICAgICBzdG9wRXZlcnl0aGluZygpOwogICAgICAgIHNldFN0YXR1cygnVEhJTktJTkcnKTsKICAgICAgICBzZXRFcnJvcihudWxsKTsKICAgICAgICBzZXRXaGl0ZWJvYXJkU3RlcHMoW10pOwogICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoMCk7CiAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBbXTsKICAgICAgICBzZXRDYW52YXNLZXkocHJldiA9PiBwcmV2ICsgMSk7CiAgICAgICAgbGV0IG1zZ0luZGV4ID0gMDsKICAgICAgICBzZXRFeHBsYW5hdGlvbihUSElOS0lOR19NRVNTQUdFU1ttc2dJbmRleF0pOwogICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgbXNnSW5kZXggPSAobXNnSW5kZXggKyAxKSAlIFRISU5LSU5HX01FU1NBR0VTLmxlbmd0aDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oVEhJTktJTkdfTUVTU0FHRVNbbXNnSW5kZXhdKTsKICAgICAgICB9LCAyNTAwKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEluaXRpYWxQbGFuKHByb21wdCk7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAvLyAtLS0gREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBjb25zdCBpc1BvaW50T2JqZWN0ID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBBYnNvbHV0ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnggPT09ICdudW1iZXInICYmIHR5cGVvZiBwLnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBSZWxhdGl2ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnJlZmVyZW5jZUNpcmNsZUlkMSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHAucmVmZXJlbmNlQ2lyY2xlSWQyID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgcC5pbnRlcnNlY3Rpb25JbmRleCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCFyZXNwb25zZSB8fCB0eXBlb2YgcmVzcG9uc2UuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnIHx8ICFBcnJheS5pc0FycmF5KHJlc3BvbnNlLndoaXRlYm9hcmQpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBBSSByZXR1cm5lZCBhbiBpbnZhbGlkIHBsYW4gc3RydWN0dXJlLiBQbGVhc2UgdHJ5IHJlcGhyYXNpbmcgeW91ciBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3BvbnNlLndoaXRlYm9hcmQubGVuZ3RoID09PSAwICYmICFyZXNwb25zZS5leHBsYW5hdGlvbikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgQUkgcmV0dXJuZWQgYW4gZW1wdHkgcGxhbi4gUGxlYXNlIHRyeSBhIGRpZmZlcmVudCBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgc3RlcF0gb2YgcmVzcG9uc2Uud2hpdGVib2FyZC5lbnRyaWVzKCkpIHsKICAgICAgICAgICAgICAgIGlmICghc3RlcCB8fCB0eXBlb2Ygc3RlcC5vcmlnaW4/LnggIT09ICdudW1iZXInIHx8IHR5cGVvZiBzdGVwLm9yaWdpbj8ueSAhPT0gJ251bWJlcicgfHwgdHlwZW9mIHN0ZXAuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwICR7aSArIDF9IGlzIG1hbGZvcm1lZCAobWlzc2luZyBvcmlnaW4gb3IgZXhwbGFuYXRpb24pLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgYWxsSXRlbXMgPSBbLi4uKHN0ZXAuZHJhd2luZ1BsYW4gfHwgW10pLCAuLi4oc3RlcC5hbm5vdGF0aW9ucyB8fCBbXSldOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBbaiwgaXRlbV0gb2YgYWxsSXRlbXMuZW50cmllcygpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpdGVtIHx8ICFpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gaXMgbWlzc2luZyBhICd0eXBlJy5gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmVjdGFuZ2xlJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY21kID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuY2VudGVyKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnY2VudGVyJyBpbiAncmVjdGFuZ2xlJyBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjaXJjbGUnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5jZW50ZXIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBvciBtaXNzaW5nICdjZW50ZXInIGluICdjaXJjbGUnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5wb2ludCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3BvaW50JyBpbiAndGV4dCcgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYXJyb3cnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5zdGFydCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3N0YXJ0JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuZW5kKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnZW5kJyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbWQuY29udHJvbFBvaW50ICYmICFpc1BvaW50T2JqZWN0KGNtZC5jb250cm9sUG9pbnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCAnY29udHJvbFBvaW50JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhdGgnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNtZC5wb2ludHMpIHx8IGNtZC5wb2ludHMubGVuZ3RoIDwgMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdwYXRoJyBhdCBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gbXVzdCBoYXZlIGEgJ3BvaW50cycgYXJyYXkgd2l0aCBhdCBsZWFzdCB0d28gcG9pbnRzLmApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIGNtZC5wb2ludHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUG9pbnRPYmplY3QocCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwb2ludCBpbiAncG9pbnRzJyBhcnJheSBmb3IgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaWtldGhyb3VnaCc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IGl0ZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY21kLnBvaW50cykgfHwgY21kLnBvaW50cy5sZW5ndGggPCAyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJ3N0cmlrZXRocm91Z2gnIGF0IEl0ZW0gJHtqICsgMX0gaW4gU3RlcCAke2kgKyAxfSBtdXN0IGhhdmUgYSAncG9pbnRzJyBhcnJheSB3aXRoIGF0IGxlYXN0IHR3byBwb2ludHMuYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgY21kLnBvaW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChwKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBvaW50IGluICdwb2ludHMnIGFycmF5IGZvciBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIC0tLSBFTkQgREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBpZiAocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNldFN0YXR1cygnRE9ORScpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFN0YXR1cygnUFJFUEFSSU5HJyk7CiAgICAgICAgICAgIG1zZ0luZGV4ID0gMDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgICAgIG1zZ0luZGV4ID0gKG1zZ0luZGV4ICsgMSkgJSBQUkVQQVJJTkdfTUVTU0FHRVMubGVuZ3RoOwogICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIH0sIDI1MDApOwogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwMCkpOwogICAgICAgICAgICBpZiAoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpCiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBuZXcgQXJyYXkocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGgpLmZpbGwobnVsbCk7CiAgICAgICAgICAgIG92ZXJhbGxFeHBsYW5hdGlvblJlZi5jdXJyZW50ID0gcmVzcG9uc2UuZXhwbGFuYXRpb247CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgc2V0V2hpdGVib2FyZFN0ZXBzKHJlc3BvbnNlLndoaXRlYm9hcmQpOwogICAgICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuJzsKICAgICAgICAgICAgc2V0RXJyb3IoYFNvcnJ5LCBJIGNvdWxkbid0IHByb2Nlc3MgdGhhdC4gJHtlcnJvck1lc3NhZ2V9YCk7CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKCdPb3BzISBTb21ldGhpbmcgd2VudCB3cm9uZy4gVGhlIGRyYXdpbmcgYXNzaXN0YW50IGVuY291bnRlcmVkIGFuIHVuZXhwZWN0ZWQgZXJyb3IuJyk7CiAgICAgICAgICAgIHNldFN0YXR1cygnRVJST1InKTsKICAgICAgICB9CiAgICB9LCBbc3RhdHVzLCBzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlUmVwZWF0ID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmICh3aGl0ZWJvYXJkU3RlcHMubGVuZ3RoID09PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICBzZXRDdXJyZW50U3RlcEluZGV4KDApOwogICAgICAgIHNldENhbnZhc0tleShwcmV2ID0+IHByZXYgKyAxKTsKICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgIH0sIFt3aGl0ZWJvYXJkU3RlcHMsIHN0b3BFdmVyeXRoaW5nXSk7CiAgICBjb25zdCBoYW5kbGVUb2dnbGVQYXVzZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICBpZiAoc3RhdHVzID09PSAnRFJBV0lORycpIHsKICAgICAgICAgICAgc2V0SXNQYXVzZWQocCA9PiAhcCk7CiAgICAgICAgfQogICAgfSwgW3N0YXR1c10pOwogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ID0gMDsKICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygwKTsKICAgIH0sIFtjdXJyZW50U3RlcEluZGV4XSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IGN1cnJlbnRTdGVwID0gd2hpdGVib2FyZFN0ZXBzW2N1cnJlbnRTdGVwSW5kZXhdOwogICAgICAgIGlmIChzdGF0dXMgIT09ICdEUkFXSU5HJyB8fCAhY3VycmVudFN0ZXAgfHwgaXNQYXVzZWQpIHsKICAgICAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudC5zdG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgICAgICBhdWRpb1NvdXJjZVJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ICs9IGVsYXBzZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgaXNDYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICBzZXRFeHBsYW5hdGlvbihjdXJyZW50U3RlcC5leHBsYW5hdGlvbik7CiAgICAgICAgaWYgKHBsYXliYWNrT2Zmc2V0UmVmLmN1cnJlbnQgPT09IDApIHsKICAgICAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBsZXRlQW5kQWR2YW5jZSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygxKTsKICAgICAgICAgICAgc3RlcFRpbWVvdXRSZWYuY3VycmVudCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNDYW5jZWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0ZXBJbmRleCA8IHdoaXRlYm9hcmRTdGVwcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoaSA9PiBpICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoJ0RPTkUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24ob3ZlcmFsbEV4cGxhbmF0aW9uUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMzc1KTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHJ1blN0ZXAgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnRbY3VycmVudFN0ZXBJbmRleF0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2U2NEF1ZGlvID0gYXdhaXQgZ2VuZXJhdGVTcGVlY2goY3VycmVudFN0ZXAuZXhwbGFuYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGJhc2U2NEF1ZGlvICYmIGF1ZGlvV29ya2VyUmVmLmN1cnJlbnQgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudC5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlOiAyNDAwMCwgbnVtQ2hhbm5lbHM6IDEsIGluZGV4OiBjdXJyZW50U3RlcEluZGV4CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IGF1ZGlvQnVmZmVyc1JlZi5jdXJyZW50W2N1cnJlbnRTdGVwSW5kZXhdIHx8IG51bGw7CiAgICAgICAgICAgIGxldCB3YWl0Q291bnQgPSAwOwogICAgICAgICAgICB3aGlsZSAoIWJ1ZmZlciAmJiB3YWl0Q291bnQgPCAxMDAgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwKSk7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtjdXJyZW50U3RlcEluZGV4XSB8fCBudWxsOwogICAgICAgICAgICAgICAgd2FpdENvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBvZmZzZXRTZWMgPSBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50OwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbk1zID0gYnVmZmVyID8gKGJ1ZmZlci5kdXJhdGlvbiAtIG9mZnNldFNlYykgKiAxMDAwIDogNDAwMDsKICAgICAgICAgICAgY29uc3Qgc3RlcFN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgICBjb25zdCBhbmltYXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UHJvZ3Jlc3MgPSAwOwogICAgICAgICAgICAgICAgaWYgKGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50ICYmIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQ/LmJ1ZmZlciAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkU2VjID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbFBsYXllZFNlYyA9IG9mZnNldFNlYyArIGVsYXBzZWRTZWM7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4odG90YWxQbGF5ZWRTZWMgLyBhdWRpb1NvdXJjZVJlZi5jdXJyZW50LmJ1ZmZlci5kdXJhdGlvbiwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkTXMgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0ZXBTdGFydFRpbWU7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4oZWxhcHNlZE1zIC8gZHVyYXRpb25NcywgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcyhjdXJyZW50UHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQcm9ncmVzcyA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICBzdGVwVGltZW91dFJlZi5jdXJyZW50ID0gd2luZG93LnNldFRpbWVvdXQoY29tcGxldGVBbmRBZHZhbmNlLCBkdXJhdGlvbk1zICsgMTAwKTsKICAgICAgICAgICAgaWYgKGJ1ZmZlciAmJiBhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBvZmZzZXRTZWMgPCBidWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgIHNvdXJjZS5jb25uZWN0KGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwLCBvZmZzZXRTZWMpOwogICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudCA9IHNvdXJjZTsKICAgICAgICAgICAgICAgIHN0YXJ0ZWRBdFJlZi5jdXJyZW50ID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJ1blN0ZXAoKTsKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBpc0NhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHN0ZXBUaW1lb3V0UmVmLmN1cnJlbnQpOwogICAgICAgIH07CiAgICB9LCBbc3RhdHVzLCBjdXJyZW50U3RlcEluZGV4LCB3aGl0ZWJvYXJkU3RlcHMsIGlzUGF1c2VkXSk7CiAgICByZXR1cm4gKF9qc3hzKCJkaXYiLCB7IGNsYXNzTmFtZTogInctc2NyZWVuIGgtc2NyZWVuIGJnLWJsYWNrIHRleHQtd2hpdGUgZm9udC1zYW5zIGZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktY2VudGVyIHJlbGF0aXZlIiwgY2hpbGRyZW46IFtfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJhYnNvbHV0ZSB0b3AtMCBsZWZ0LTAgcmlnaHQtMCBwLTQgZmxleCBqdXN0aWZ5LWJldHdlZW4gaXRlbXMtY2VudGVyIHotMTAgcG9pbnRlci1ldmVudHMtbm9uZSIsIGNoaWxkcmVuOiBbX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJwb2ludGVyLWV2ZW50cy1hdXRvIiwgY2hpbGRyZW46IF9qc3goTG9nb0ljb24sIHsgY2xhc3NOYW1lOiAiaC04IHctYXV0byIgfSkgfSksIF9qc3goImRpdiIsIHsgY2xhc3NOYW1lOiAicG9pbnRlci1ldmVudHMtYXV0byIsIGNoaWxkcmVuOiBfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtNCBiZy13aGl0ZS81IGJhY2tkcm9wLWJsdXIteGwgYm9yZGVyIGJvcmRlci13aGl0ZS8xMCByb3VuZGVkLWZ1bGwgcHgtNCBweS0xLjUgdGV4dC1zbSB0ZXh0LWdyYXktNTAwIHNoYWRvdy1sZyIsIGNoaWxkcmVuOiBbX2pzeCgic3BhbiIsIHsgY2hpbGRyZW46ICJSZXNlYXJjaCBQcmV2aWV3IiB9KSwgX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJ3LXB4IGgtNCBiZy13aGl0ZS8yMCIgfSksIF9qc3goImEiLCB7IGhyZWY6ICJtYWlsdG86YWktZHJhd2luZy1hc3Npc3RhbnQtZmVlZGJhY2tAZ29vZ2xlLmNvbSIsIHRhcmdldDogIl9ibGFuayIsIHJlbDogIm5vb3BlbmVyIG5vcmVmZXJyZXIiLCB0aXRsZTogIkVtYWlsIFVzIiwgY2xhc3NOYW1lOiAidGV4dC1ncmF5LTQwMCBob3Zlcjp0ZXh0LWN5YW4tNDAwIHRyYW5zaXRpb24tYWxsIGR1cmF0aW9uLTMwMCBob3Zlcjpkcm9wLXNoYWRvdy1bMF8wXzRweF9yZ2JhKDM0LDIxMSwyMzgsMC44KV0iLCBjaGlsZHJlbjogX2pzeChNYWlsSWNvbiwgeyBjbGFzc05hbWU6ICJ3LTUgaC01IiB9KSB9KSwgX2pzeCgiYSIsIHsgaHJlZjogImh0dHBzOi8vZ2l0aHViLmNvbS9nb29nbGUvYWlzdHVkaW8td2ViIiwgdGFyZ2V0OiAiX2JsYW5rIiwgcmVsOiAibm9vcGVuZXIgbm9yZWZlcnJlciIsIHRpdGxlOiAiVmlldyBvbiBHaXRIdWIiLCBjbGFzc05hbWU6ICJ0ZXh0LWdyYXktNDAwIGhvdmVyOnRleHQtd2hpdGUgdHJhbnNpdGlvbi1hbGwgZHVyYXRpb24tMzAwIGhvdmVyOmRyb3Atc2hhZG93LVswXzBfNHB4X3JnYmEoMjU1LDI1NSwyNTUsMC44KV0iLCBjaGlsZHJlbjogX2pzeChHaXRodWJJY29uLCB7IGNsYXNzTmFtZTogInctNSBoLTUiIH0pIH0pXSB9KSB9KV0gfSksIF9qc3goQ2FudmFzLCB7IHN0ZXBzOiB3aGl0ZWJvYXJkU3RlcHMsIGN1cnJlbnRTdGVwSW5kZXg6IGN1cnJlbnRTdGVwSW5kZXgsIHN0YXR1czogc3RhdHVzLCBhbmltYXRpb25Qcm9ncmVzczogYW5pbWF0aW9uUHJvZ3Jlc3MsIGlzUGF1c2VkOiBpc1BhdXNlZCwgZXhwbGFuYXRpb246IGV4cGxhbmF0aW9uIH0sIGNhbnZhc0tleSksIF9qc3goQ29udHJvbHMsIHsgc3RhdHVzOiBzdGF0dXMsIGV4cGxhbmF0aW9uOiBleHBsYW5hdGlvbiwgZXJyb3I6IGVycm9yLCBzdGVwczogd2hpdGVib2FyZFN0ZXBzLCBjdXJyZW50U3RlcEluZGV4OiBjdXJyZW50U3RlcEluZGV4LCBpc1BhdXNlZDogaXNQYXVzZWQsIG9uU3VibWl0OiBoYW5kbGVTdWJtaXQsIG9uUmVwZWF0OiBoYW5kbGVSZXBlYXQsIG9uVG9nZ2xlUGF1c2U6IGhhbmRsZVRvZ2dsZVBhdXNlIH0pXSB9KSk7Cn07CmV4cG9ydCBkZWZhdWx0IEFwcDsK:248 Error: Invalid point in 'points' array for Item 1, Step 1
    at data:application/javascript;base64,aW1wb3J0IHsganN4IGFzIF9qc3gsIGpzeHMgYXMgX2pzeHMgfSBmcm9tICJyZWFjdC9qc3gtcnVudGltZSI7CmltcG9ydCB7IHVzZVN0YXRlLCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7CmltcG9ydCB7IENhbnZhcyB9IGZyb20gJ0AvY29tcG9uZW50cy9DYW52YXMnOwppbXBvcnQgeyBDb250cm9scyB9IGZyb20gJ0AvY29tcG9uZW50cy9Db250cm9scyc7CmltcG9ydCB7IGdldEluaXRpYWxQbGFuLCBnZW5lcmF0ZVNwZWVjaCB9IGZyb20gJ0Avc2VydmljZXMvZ2VtaW5pU2VydmljZSc7CmltcG9ydCB7IE1haWxJY29uLCBHaXRodWJJY29uLCBMb2dvSWNvbiB9IGZyb20gJ0AvY29tcG9uZW50cy9pY29ucyc7Ci8vIFRoaXMgaXMgdGhlIGNvZGUgdGhhdCB3aWxsIHJ1biBpbiB0aGUgYmFja2dyb3VuZCB0aHJlYWQgdG8gYXZvaWQgYmxvY2tpbmcgdGhlIFVJLgpjb25zdCBhdWRpb1dvcmtlckNvZGUgPSBgCiAgLy8gVGhpcyBkZWNvZGUgZnVuY3Rpb24gbm93IGxpdmVzIGluc2lkZSB0aGUgd29ya2VyLCBvZmYgdGhlIG1haW4gdGhyZWFkLgogIGZ1bmN0aW9uIGRlY29kZShiYXNlNjQpIHsKICAgIGNvbnN0IGJpbmFyeVN0cmluZyA9IGF0b2IoYmFzZTY0KTsKICAgIGNvbnN0IGxlbiA9IGJpbmFyeVN0cmluZy5sZW5ndGg7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGJ5dGVzW2ldID0gYmluYXJ5U3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQoKICBzZWxmLm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICBjb25zdCB7IGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlLCBudW1DaGFubmVscywgaW5kZXggfSA9IGUuZGF0YTsKICAgIAogICAgLy8gMS4gRGVjb2RlIHRoZSBiYXNlNjQgc3RyaW5nIHRvIGEgVWludDhBcnJheSAodGhlIGJsb2NraW5nIHBhcnQpCiAgICBjb25zdCBhdWRpb0RhdGEgPSBkZWNvZGUoYmFzZTY0QXVkaW8pOwogICAgCiAgICAvLyAyLiBQcm9jZXNzIHRoZSByYXcgYXVkaW8gZGF0YSBpbnRvIGZsb2F0IGNoYW5uZWxzCiAgICBjb25zdCBkYXRhSW50MTYgPSBuZXcgSW50MTZBcnJheShhdWRpb0RhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGZyYW1lQ291bnQgPSBkYXRhSW50MTYubGVuZ3RoIC8gbnVtQ2hhbm5lbHM7CiAgICAKICAgIGNvbnN0IGNoYW5uZWxzID0gW107CiAgICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IG51bUNoYW5uZWxzOyBjaGFubmVsKyspIHsKICAgICAgY29uc3QgY2hhbm5lbERhdGEgPSBuZXcgRmxvYXQzMkFycmF5KGZyYW1lQ291bnQpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lQ291bnQ7IGkrKykgewogICAgICAgIGNoYW5uZWxEYXRhW2ldID0gZGF0YUludDE2W2kgKiBudW1DaGFubmVscyArIGNoYW5uZWxdIC8gMzI3NjguMDsKICAgICAgfQogICAgICBjaGFubmVscy5wdXNoKGNoYW5uZWxEYXRhKTsKICAgIH0KCiAgICAvLyAzLiBTZW5kIHRoZSBwcm9jZXNzZWQgZGF0YSBiYWNrIHRvIHRoZSBtYWluIHRocmVhZCBmb3IgZmFzdCBidWZmZXIgY3JlYXRpb24uCiAgICBzZWxmLnBvc3RNZXNzYWdlKHsgY2hhbm5lbHMsIGZyYW1lQ291bnQsIHNhbXBsZVJhdGUsIGluZGV4IH0sIGNoYW5uZWxzLm1hcChjID0+IGMuYnVmZmVyKSk7CiAgfTsKYDsKY29uc3QgVEhJTktJTkdfTUVTU0FHRVMgPSBbCiAgICAnQ29uY2VwdHVhbGl6aW5nIHRoZSB2aXN1YWwgc3RvcnkuLi4nLAogICAgJ0NvbnN1bHRpbmcgbXkgaW50ZXJuYWwga25vd2xlZGdlIGJhc2UuLi4nLAogICAgJ0JyZWFraW5nIHRoZSB0b3BpYyBpbnRvIGRpZ2VzdGlibGUgc3RlcHMuLi4nLAogICAgJ1RoaXMgaXMgYSBjcmVhdGl2ZSBvbmUhIEJyYWluc3Rvcm1pbmcgbWlnaHQgdGFrZSBhIG1vbWVudC4uLicsCiAgICAnU2tldGNoaW5nIG91dCB0aGUgbmFycmF0aXZlIGFyYy4uLicsCiAgICAnUGxhbm5pbmcgdGhlIG9wdGltYWwgdmlzdWFsIGZsb3cuLi4nLApdOwpjb25zdCBQUkVQQVJJTkdfTUVTU0FHRVMgPSBbCiAgICAnV2FybWluZyB1cCBteSB2aXJ0dWFsIGRyYXdpbmcgaGFuZC4uLicsCiAgICAnQ2hvcmVvZ3JhcGhpbmcgdGhlIGFuaW1hdGlvbiBzZXF1ZW5jZS4uLicsCiAgICAnUHJlcGFyaW5nIHRoZSBjYW52YXMuLi4nLAogICAgJ0ZpbmFsaXppbmcgdGhlIGxlc3NvbiBwbGFuLi4uJywKXTsKY29uc3QgQXBwID0gKCkgPT4gewogICAgY29uc3QgW3N0YXR1cywgc2V0U3RhdHVzXSA9IHVzZVN0YXRlKCdJRExFJyk7CiAgICBjb25zdCBbZXhwbGFuYXRpb24sIHNldEV4cGxhbmF0aW9uXSA9IHVzZVN0YXRlKCdFbnRlciBhIHByb21wdCBhbmQgSVwnbGwgY3JlYXRlIGEgdm9pY2UtbGVkIHZpc3VhbCBleHBsYW5hdGlvbiBmb3IgeW91LicpOwogICAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZShudWxsKTsKICAgIGNvbnN0IFt3aGl0ZWJvYXJkU3RlcHMsIHNldFdoaXRlYm9hcmRTdGVwc10gPSB1c2VTdGF0ZShbXSk7CiAgICBjb25zdCBbY3VycmVudFN0ZXBJbmRleCwgc2V0Q3VycmVudFN0ZXBJbmRleF0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtjYW52YXNLZXksIHNldENhbnZhc0tleV0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtpc1BhdXNlZCwgc2V0SXNQYXVzZWRdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgLy8gLS0tIEF1ZGlvICYgQW5pbWF0aW9uIEVuZ2luZSBSZWZzIC0tLQogICAgY29uc3QgYXVkaW9Db250ZXh0UmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3QgYXVkaW9Xb3JrZXJSZWYgPSB1c2VSZWYobnVsbCk7CiAgICBjb25zdCBhdWRpb1NvdXJjZVJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGF1ZGlvQnVmZmVyc1JlZiA9IHVzZVJlZihbXSk7CiAgICBjb25zdCBzdGVwVGltZW91dFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGFuaW1hdGlvbkZyYW1lUmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3Qgb3ZlcmFsbEV4cGxhbmF0aW9uUmVmID0gdXNlUmVmKCcnKTsKICAgIGNvbnN0IHBsYXliYWNrT2Zmc2V0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3Qgc3RhcnRlZEF0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3QgW2FuaW1hdGlvblByb2dyZXNzLCBzZXRBbmltYXRpb25Qcm9ncmVzc10gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IHN0b3BFdmVyeXRoaW5nID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RlcFRpbWVvdXRSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7IC8qIGlnbm9yZSAqLyB9CiAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzZXRJc1BhdXNlZChmYWxzZSk7CiAgICAgICAgcGxheWJhY2tPZmZzZXRSZWYuY3VycmVudCA9IDA7CiAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICB9LCBbXSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBhdWRpb0NvbnRleHRSZWYuY3VycmVudCA9IG5ldyAod2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0KSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2F1ZGlvV29ya2VyQ29kZV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnIH0pOwogICAgICAgIGNvbnN0IHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CiAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudCA9IHdvcmtlcjsKICAgICAgICB3b3JrZXIub25tZXNzYWdlID0gKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgeyBjaGFubmVscywgZnJhbWVDb3VudCwgc2FtcGxlUmF0ZSwgaW5kZXggfSA9IGUuZGF0YTsKICAgICAgICAgICAgaWYgKCFhdWRpb0NvbnRleHRSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhdWRpb0NvbnRleHRSZWYuY3VycmVudC5jcmVhdGVCdWZmZXIoY2hhbm5lbHMubGVuZ3RoLCBmcmFtZUNvdW50LCBzYW1wbGVSYXRlKTsKICAgICAgICAgICAgY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbERhdGEsIGkpID0+IHsKICAgICAgICAgICAgICAgIGF1ZGlvQnVmZmVyLmdldENoYW5uZWxEYXRhKGkpLnNldChjaGFubmVsRGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtpbmRleF0gPSBhdWRpb0J1ZmZlcjsKICAgICAgICB9OwogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIHdvcmtlci50ZXJtaW5hdGUoKTsKICAgICAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICAgICAgYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQ/LmNsb3NlKCk7CiAgICAgICAgfTsKICAgIH0sIFtzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gdXNlQ2FsbGJhY2soYXN5bmMgKHByb21wdCkgPT4gewogICAgICAgIGlmICghcHJvbXB0LnRyaW0oKSB8fCBzdGF0dXMgPT09ICdUSElOS0lORycgfHwgc3RhdHVzID09PSAnUFJFUEFSSU5HJykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudD8uc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB7CiAgICAgICAgICAgIGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LnJlc3VtZSgpOwogICAgICAgIH0KICAgICAgICBzdG9wRXZlcnl0aGluZygpOwogICAgICAgIHNldFN0YXR1cygnVEhJTktJTkcnKTsKICAgICAgICBzZXRFcnJvcihudWxsKTsKICAgICAgICBzZXRXaGl0ZWJvYXJkU3RlcHMoW10pOwogICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoMCk7CiAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBbXTsKICAgICAgICBzZXRDYW52YXNLZXkocHJldiA9PiBwcmV2ICsgMSk7CiAgICAgICAgbGV0IG1zZ0luZGV4ID0gMDsKICAgICAgICBzZXRFeHBsYW5hdGlvbihUSElOS0lOR19NRVNTQUdFU1ttc2dJbmRleF0pOwogICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgbXNnSW5kZXggPSAobXNnSW5kZXggKyAxKSAlIFRISU5LSU5HX01FU1NBR0VTLmxlbmd0aDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oVEhJTktJTkdfTUVTU0FHRVNbbXNnSW5kZXhdKTsKICAgICAgICB9LCAyNTAwKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEluaXRpYWxQbGFuKHByb21wdCk7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAvLyAtLS0gREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBjb25zdCBpc1BvaW50T2JqZWN0ID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBBYnNvbHV0ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnggPT09ICdudW1iZXInICYmIHR5cGVvZiBwLnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBSZWxhdGl2ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnJlZmVyZW5jZUNpcmNsZUlkMSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHAucmVmZXJlbmNlQ2lyY2xlSWQyID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgcC5pbnRlcnNlY3Rpb25JbmRleCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCFyZXNwb25zZSB8fCB0eXBlb2YgcmVzcG9uc2UuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnIHx8ICFBcnJheS5pc0FycmF5KHJlc3BvbnNlLndoaXRlYm9hcmQpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBBSSByZXR1cm5lZCBhbiBpbnZhbGlkIHBsYW4gc3RydWN0dXJlLiBQbGVhc2UgdHJ5IHJlcGhyYXNpbmcgeW91ciBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3BvbnNlLndoaXRlYm9hcmQubGVuZ3RoID09PSAwICYmICFyZXNwb25zZS5leHBsYW5hdGlvbikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgQUkgcmV0dXJuZWQgYW4gZW1wdHkgcGxhbi4gUGxlYXNlIHRyeSBhIGRpZmZlcmVudCBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgc3RlcF0gb2YgcmVzcG9uc2Uud2hpdGVib2FyZC5lbnRyaWVzKCkpIHsKICAgICAgICAgICAgICAgIGlmICghc3RlcCB8fCB0eXBlb2Ygc3RlcC5vcmlnaW4/LnggIT09ICdudW1iZXInIHx8IHR5cGVvZiBzdGVwLm9yaWdpbj8ueSAhPT0gJ251bWJlcicgfHwgdHlwZW9mIHN0ZXAuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwICR7aSArIDF9IGlzIG1hbGZvcm1lZCAobWlzc2luZyBvcmlnaW4gb3IgZXhwbGFuYXRpb24pLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgYWxsSXRlbXMgPSBbLi4uKHN0ZXAuZHJhd2luZ1BsYW4gfHwgW10pLCAuLi4oc3RlcC5hbm5vdGF0aW9ucyB8fCBbXSldOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBbaiwgaXRlbV0gb2YgYWxsSXRlbXMuZW50cmllcygpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpdGVtIHx8ICFpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gaXMgbWlzc2luZyBhICd0eXBlJy5gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmVjdGFuZ2xlJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY21kID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuY2VudGVyKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnY2VudGVyJyBpbiAncmVjdGFuZ2xlJyBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjaXJjbGUnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5jZW50ZXIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBvciBtaXNzaW5nICdjZW50ZXInIGluICdjaXJjbGUnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5wb2ludCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3BvaW50JyBpbiAndGV4dCcgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYXJyb3cnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5zdGFydCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3N0YXJ0JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuZW5kKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnZW5kJyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbWQuY29udHJvbFBvaW50ICYmICFpc1BvaW50T2JqZWN0KGNtZC5jb250cm9sUG9pbnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCAnY29udHJvbFBvaW50JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhdGgnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNtZC5wb2ludHMpIHx8IGNtZC5wb2ludHMubGVuZ3RoIDwgMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdwYXRoJyBhdCBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gbXVzdCBoYXZlIGEgJ3BvaW50cycgYXJyYXkgd2l0aCBhdCBsZWFzdCB0d28gcG9pbnRzLmApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIGNtZC5wb2ludHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUG9pbnRPYmplY3QocCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwb2ludCBpbiAncG9pbnRzJyBhcnJheSBmb3IgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaWtldGhyb3VnaCc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IGl0ZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY21kLnBvaW50cykgfHwgY21kLnBvaW50cy5sZW5ndGggPCAyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJ3N0cmlrZXRocm91Z2gnIGF0IEl0ZW0gJHtqICsgMX0gaW4gU3RlcCAke2kgKyAxfSBtdXN0IGhhdmUgYSAncG9pbnRzJyBhcnJheSB3aXRoIGF0IGxlYXN0IHR3byBwb2ludHMuYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgY21kLnBvaW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChwKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBvaW50IGluICdwb2ludHMnIGFycmF5IGZvciBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIC0tLSBFTkQgREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBpZiAocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNldFN0YXR1cygnRE9ORScpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFN0YXR1cygnUFJFUEFSSU5HJyk7CiAgICAgICAgICAgIG1zZ0luZGV4ID0gMDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgICAgIG1zZ0luZGV4ID0gKG1zZ0luZGV4ICsgMSkgJSBQUkVQQVJJTkdfTUVTU0FHRVMubGVuZ3RoOwogICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIH0sIDI1MDApOwogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwMCkpOwogICAgICAgICAgICBpZiAoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpCiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBuZXcgQXJyYXkocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGgpLmZpbGwobnVsbCk7CiAgICAgICAgICAgIG92ZXJhbGxFeHBsYW5hdGlvblJlZi5jdXJyZW50ID0gcmVzcG9uc2UuZXhwbGFuYXRpb247CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgc2V0V2hpdGVib2FyZFN0ZXBzKHJlc3BvbnNlLndoaXRlYm9hcmQpOwogICAgICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuJzsKICAgICAgICAgICAgc2V0RXJyb3IoYFNvcnJ5LCBJIGNvdWxkbid0IHByb2Nlc3MgdGhhdC4gJHtlcnJvck1lc3NhZ2V9YCk7CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKCdPb3BzISBTb21ldGhpbmcgd2VudCB3cm9uZy4gVGhlIGRyYXdpbmcgYXNzaXN0YW50IGVuY291bnRlcmVkIGFuIHVuZXhwZWN0ZWQgZXJyb3IuJyk7CiAgICAgICAgICAgIHNldFN0YXR1cygnRVJST1InKTsKICAgICAgICB9CiAgICB9LCBbc3RhdHVzLCBzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlUmVwZWF0ID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmICh3aGl0ZWJvYXJkU3RlcHMubGVuZ3RoID09PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICBzZXRDdXJyZW50U3RlcEluZGV4KDApOwogICAgICAgIHNldENhbnZhc0tleShwcmV2ID0+IHByZXYgKyAxKTsKICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgIH0sIFt3aGl0ZWJvYXJkU3RlcHMsIHN0b3BFdmVyeXRoaW5nXSk7CiAgICBjb25zdCBoYW5kbGVUb2dnbGVQYXVzZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICBpZiAoc3RhdHVzID09PSAnRFJBV0lORycpIHsKICAgICAgICAgICAgc2V0SXNQYXVzZWQocCA9PiAhcCk7CiAgICAgICAgfQogICAgfSwgW3N0YXR1c10pOwogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ID0gMDsKICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygwKTsKICAgIH0sIFtjdXJyZW50U3RlcEluZGV4XSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IGN1cnJlbnRTdGVwID0gd2hpdGVib2FyZFN0ZXBzW2N1cnJlbnRTdGVwSW5kZXhdOwogICAgICAgIGlmIChzdGF0dXMgIT09ICdEUkFXSU5HJyB8fCAhY3VycmVudFN0ZXAgfHwgaXNQYXVzZWQpIHsKICAgICAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudC5zdG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgICAgICBhdWRpb1NvdXJjZVJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ICs9IGVsYXBzZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgaXNDYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICBzZXRFeHBsYW5hdGlvbihjdXJyZW50U3RlcC5leHBsYW5hdGlvbik7CiAgICAgICAgaWYgKHBsYXliYWNrT2Zmc2V0UmVmLmN1cnJlbnQgPT09IDApIHsKICAgICAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBsZXRlQW5kQWR2YW5jZSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygxKTsKICAgICAgICAgICAgc3RlcFRpbWVvdXRSZWYuY3VycmVudCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNDYW5jZWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0ZXBJbmRleCA8IHdoaXRlYm9hcmRTdGVwcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoaSA9PiBpICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoJ0RPTkUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24ob3ZlcmFsbEV4cGxhbmF0aW9uUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMzc1KTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHJ1blN0ZXAgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnRbY3VycmVudFN0ZXBJbmRleF0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2U2NEF1ZGlvID0gYXdhaXQgZ2VuZXJhdGVTcGVlY2goY3VycmVudFN0ZXAuZXhwbGFuYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGJhc2U2NEF1ZGlvICYmIGF1ZGlvV29ya2VyUmVmLmN1cnJlbnQgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudC5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlOiAyNDAwMCwgbnVtQ2hhbm5lbHM6IDEsIGluZGV4OiBjdXJyZW50U3RlcEluZGV4CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IGF1ZGlvQnVmZmVyc1JlZi5jdXJyZW50W2N1cnJlbnRTdGVwSW5kZXhdIHx8IG51bGw7CiAgICAgICAgICAgIGxldCB3YWl0Q291bnQgPSAwOwogICAgICAgICAgICB3aGlsZSAoIWJ1ZmZlciAmJiB3YWl0Q291bnQgPCAxMDAgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwKSk7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtjdXJyZW50U3RlcEluZGV4XSB8fCBudWxsOwogICAgICAgICAgICAgICAgd2FpdENvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBvZmZzZXRTZWMgPSBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50OwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbk1zID0gYnVmZmVyID8gKGJ1ZmZlci5kdXJhdGlvbiAtIG9mZnNldFNlYykgKiAxMDAwIDogNDAwMDsKICAgICAgICAgICAgY29uc3Qgc3RlcFN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgICBjb25zdCBhbmltYXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UHJvZ3Jlc3MgPSAwOwogICAgICAgICAgICAgICAgaWYgKGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50ICYmIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQ/LmJ1ZmZlciAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkU2VjID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbFBsYXllZFNlYyA9IG9mZnNldFNlYyArIGVsYXBzZWRTZWM7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4odG90YWxQbGF5ZWRTZWMgLyBhdWRpb1NvdXJjZVJlZi5jdXJyZW50LmJ1ZmZlci5kdXJhdGlvbiwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkTXMgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0ZXBTdGFydFRpbWU7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4oZWxhcHNlZE1zIC8gZHVyYXRpb25NcywgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcyhjdXJyZW50UHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQcm9ncmVzcyA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICBzdGVwVGltZW91dFJlZi5jdXJyZW50ID0gd2luZG93LnNldFRpbWVvdXQoY29tcGxldGVBbmRBZHZhbmNlLCBkdXJhdGlvbk1zICsgMTAwKTsKICAgICAgICAgICAgaWYgKGJ1ZmZlciAmJiBhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBvZmZzZXRTZWMgPCBidWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgIHNvdXJjZS5jb25uZWN0KGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwLCBvZmZzZXRTZWMpOwogICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudCA9IHNvdXJjZTsKICAgICAgICAgICAgICAgIHN0YXJ0ZWRBdFJlZi5jdXJyZW50ID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJ1blN0ZXAoKTsKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBpc0NhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHN0ZXBUaW1lb3V0UmVmLmN1cnJlbnQpOwogICAgICAgIH07CiAgICB9LCBbc3RhdHVzLCBjdXJyZW50U3RlcEluZGV4LCB3aGl0ZWJvYXJkU3RlcHMsIGlzUGF1c2VkXSk7CiAgICByZXR1cm4gKF9qc3hzKCJkaXYiLCB7IGNsYXNzTmFtZTogInctc2NyZWVuIGgtc2NyZWVuIGJnLWJsYWNrIHRleHQtd2hpdGUgZm9udC1zYW5zIGZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktY2VudGVyIHJlbGF0aXZlIiwgY2hpbGRyZW46IFtfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJhYnNvbHV0ZSB0b3AtMCBsZWZ0LTAgcmlnaHQtMCBwLTQgZmxleCBqdXN0aWZ5LWJldHdlZW4gaXRlbXMtY2VudGVyIHotMTAgcG9pbnRlci1ldmVudHMtbm9uZSIsIGNoaWxkcmVuOiBbX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJwb2ludGVyLWV2ZW50cy1hdXRvIiwgY2hpbGRyZW46IF9qc3goTG9nb0ljb24sIHsgY2xhc3NOYW1lOiAiaC04IHctYXV0byIgfSkgfSksIF9qc3goImRpdiIsIHsgY2xhc3NOYW1lOiAicG9pbnRlci1ldmVudHMtYXV0byIsIGNoaWxkcmVuOiBfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtNCBiZy13aGl0ZS81IGJhY2tkcm9wLWJsdXIteGwgYm9yZGVyIGJvcmRlci13aGl0ZS8xMCByb3VuZGVkLWZ1bGwgcHgtNCBweS0xLjUgdGV4dC1zbSB0ZXh0LWdyYXktNTAwIHNoYWRvdy1sZyIsIGNoaWxkcmVuOiBbX2pzeCgic3BhbiIsIHsgY2hpbGRyZW46ICJSZXNlYXJjaCBQcmV2aWV3IiB9KSwgX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJ3LXB4IGgtNCBiZy13aGl0ZS8yMCIgfSksIF9qc3goImEiLCB7IGhyZWY6ICJtYWlsdG86YWktZHJhd2luZy1hc3Npc3RhbnQtZmVlZGJhY2tAZ29vZ2xlLmNvbSIsIHRhcmdldDogIl9ibGFuayIsIHJlbDogIm5vb3BlbmVyIG5vcmVmZXJyZXIiLCB0aXRsZTogIkVtYWlsIFVzIiwgY2xhc3NOYW1lOiAidGV4dC1ncmF5LTQwMCBob3Zlcjp0ZXh0LWN5YW4tNDAwIHRyYW5zaXRpb24tYWxsIGR1cmF0aW9uLTMwMCBob3Zlcjpkcm9wLXNoYWRvdy1bMF8wXzRweF9yZ2JhKDM0LDIxMSwyMzgsMC44KV0iLCBjaGlsZHJlbjogX2pzeChNYWlsSWNvbiwgeyBjbGFzc05hbWU6ICJ3LTUgaC01IiB9KSB9KSwgX2pzeCgiYSIsIHsgaHJlZjogImh0dHBzOi8vZ2l0aHViLmNvbS9nb29nbGUvYWlzdHVkaW8td2ViIiwgdGFyZ2V0OiAiX2JsYW5rIiwgcmVsOiAibm9vcGVuZXIgbm9yZWZlcnJlciIsIHRpdGxlOiAiVmlldyBvbiBHaXRIdWIiLCBjbGFzc05hbWU6ICJ0ZXh0LWdyYXktNDAwIGhvdmVyOnRleHQtd2hpdGUgdHJhbnNpdGlvbi1hbGwgZHVyYXRpb24tMzAwIGhvdmVyOmRyb3Atc2hhZG93LVswXzBfNHB4X3JnYmEoMjU1LDI1NSwyNTUsMC44KV0iLCBjaGlsZHJlbjogX2pzeChHaXRodWJJY29uLCB7IGNsYXNzTmFtZTogInctNSBoLTUiIH0pIH0pXSB9KSB9KV0gfSksIF9qc3goQ2FudmFzLCB7IHN0ZXBzOiB3aGl0ZWJvYXJkU3RlcHMsIGN1cnJlbnRTdGVwSW5kZXg6IGN1cnJlbnRTdGVwSW5kZXgsIHN0YXR1czogc3RhdHVzLCBhbmltYXRpb25Qcm9ncmVzczogYW5pbWF0aW9uUHJvZ3Jlc3MsIGlzUGF1c2VkOiBpc1BhdXNlZCwgZXhwbGFuYXRpb246IGV4cGxhbmF0aW9uIH0sIGNhbnZhc0tleSksIF9qc3goQ29udHJvbHMsIHsgc3RhdHVzOiBzdGF0dXMsIGV4cGxhbmF0aW9uOiBleHBsYW5hdGlvbiwgZXJyb3I6IGVycm9yLCBzdGVwczogd2hpdGVib2FyZFN0ZXBzLCBjdXJyZW50U3RlcEluZGV4OiBjdXJyZW50U3RlcEluZGV4LCBpc1BhdXNlZDogaXNQYXVzZWQsIG9uU3VibWl0OiBoYW5kbGVTdWJtaXQsIG9uUmVwZWF0OiBoYW5kbGVSZXBlYXQsIG9uVG9nZ2xlUGF1c2U6IGhhbmRsZVRvZ2dsZVBhdXNlIH0pXSB9KSk7Cn07CmV4cG9ydCBkZWZhdWx0IEFwcDsK:206:43
(anonymous) @ data:application/javascript;base64,aW1wb3J0IHsganN4IGFzIF9qc3gsIGpzeHMgYXMgX2pzeHMgfSBmcm9tICJyZWFjdC9qc3gtcnVudGltZSI7CmltcG9ydCB7IHVzZVN0YXRlLCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7CmltcG9ydCB7IENhbnZhcyB9IGZyb20gJ0AvY29tcG9uZW50cy9DYW52YXMnOwppbXBvcnQgeyBDb250cm9scyB9IGZyb20gJ0AvY29tcG9uZW50cy9Db250cm9scyc7CmltcG9ydCB7IGdldEluaXRpYWxQbGFuLCBnZW5lcmF0ZVNwZWVjaCB9IGZyb20gJ0Avc2VydmljZXMvZ2VtaW5pU2VydmljZSc7CmltcG9ydCB7IE1haWxJY29uLCBHaXRodWJJY29uLCBMb2dvSWNvbiB9IGZyb20gJ0AvY29tcG9uZW50cy9pY29ucyc7Ci8vIFRoaXMgaXMgdGhlIGNvZGUgdGhhdCB3aWxsIHJ1biBpbiB0aGUgYmFja2dyb3VuZCB0aHJlYWQgdG8gYXZvaWQgYmxvY2tpbmcgdGhlIFVJLgpjb25zdCBhdWRpb1dvcmtlckNvZGUgPSBgCiAgLy8gVGhpcyBkZWNvZGUgZnVuY3Rpb24gbm93IGxpdmVzIGluc2lkZSB0aGUgd29ya2VyLCBvZmYgdGhlIG1haW4gdGhyZWFkLgogIGZ1bmN0aW9uIGRlY29kZShiYXNlNjQpIHsKICAgIGNvbnN0IGJpbmFyeVN0cmluZyA9IGF0b2IoYmFzZTY0KTsKICAgIGNvbnN0IGxlbiA9IGJpbmFyeVN0cmluZy5sZW5ndGg7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGJ5dGVzW2ldID0gYmluYXJ5U3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQoKICBzZWxmLm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICBjb25zdCB7IGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlLCBudW1DaGFubmVscywgaW5kZXggfSA9IGUuZGF0YTsKICAgIAogICAgLy8gMS4gRGVjb2RlIHRoZSBiYXNlNjQgc3RyaW5nIHRvIGEgVWludDhBcnJheSAodGhlIGJsb2NraW5nIHBhcnQpCiAgICBjb25zdCBhdWRpb0RhdGEgPSBkZWNvZGUoYmFzZTY0QXVkaW8pOwogICAgCiAgICAvLyAyLiBQcm9jZXNzIHRoZSByYXcgYXVkaW8gZGF0YSBpbnRvIGZsb2F0IGNoYW5uZWxzCiAgICBjb25zdCBkYXRhSW50MTYgPSBuZXcgSW50MTZBcnJheShhdWRpb0RhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGZyYW1lQ291bnQgPSBkYXRhSW50MTYubGVuZ3RoIC8gbnVtQ2hhbm5lbHM7CiAgICAKICAgIGNvbnN0IGNoYW5uZWxzID0gW107CiAgICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IG51bUNoYW5uZWxzOyBjaGFubmVsKyspIHsKICAgICAgY29uc3QgY2hhbm5lbERhdGEgPSBuZXcgRmxvYXQzMkFycmF5KGZyYW1lQ291bnQpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lQ291bnQ7IGkrKykgewogICAgICAgIGNoYW5uZWxEYXRhW2ldID0gZGF0YUludDE2W2kgKiBudW1DaGFubmVscyArIGNoYW5uZWxdIC8gMzI3NjguMDsKICAgICAgfQogICAgICBjaGFubmVscy5wdXNoKGNoYW5uZWxEYXRhKTsKICAgIH0KCiAgICAvLyAzLiBTZW5kIHRoZSBwcm9jZXNzZWQgZGF0YSBiYWNrIHRvIHRoZSBtYWluIHRocmVhZCBmb3IgZmFzdCBidWZmZXIgY3JlYXRpb24uCiAgICBzZWxmLnBvc3RNZXNzYWdlKHsgY2hhbm5lbHMsIGZyYW1lQ291bnQsIHNhbXBsZVJhdGUsIGluZGV4IH0sIGNoYW5uZWxzLm1hcChjID0+IGMuYnVmZmVyKSk7CiAgfTsKYDsKY29uc3QgVEhJTktJTkdfTUVTU0FHRVMgPSBbCiAgICAnQ29uY2VwdHVhbGl6aW5nIHRoZSB2aXN1YWwgc3RvcnkuLi4nLAogICAgJ0NvbnN1bHRpbmcgbXkgaW50ZXJuYWwga25vd2xlZGdlIGJhc2UuLi4nLAogICAgJ0JyZWFraW5nIHRoZSB0b3BpYyBpbnRvIGRpZ2VzdGlibGUgc3RlcHMuLi4nLAogICAgJ1RoaXMgaXMgYSBjcmVhdGl2ZSBvbmUhIEJyYWluc3Rvcm1pbmcgbWlnaHQgdGFrZSBhIG1vbWVudC4uLicsCiAgICAnU2tldGNoaW5nIG91dCB0aGUgbmFycmF0aXZlIGFyYy4uLicsCiAgICAnUGxhbm5pbmcgdGhlIG9wdGltYWwgdmlzdWFsIGZsb3cuLi4nLApdOwpjb25zdCBQUkVQQVJJTkdfTUVTU0FHRVMgPSBbCiAgICAnV2FybWluZyB1cCBteSB2aXJ0dWFsIGRyYXdpbmcgaGFuZC4uLicsCiAgICAnQ2hvcmVvZ3JhcGhpbmcgdGhlIGFuaW1hdGlvbiBzZXF1ZW5jZS4uLicsCiAgICAnUHJlcGFyaW5nIHRoZSBjYW52YXMuLi4nLAogICAgJ0ZpbmFsaXppbmcgdGhlIGxlc3NvbiBwbGFuLi4uJywKXTsKY29uc3QgQXBwID0gKCkgPT4gewogICAgY29uc3QgW3N0YXR1cywgc2V0U3RhdHVzXSA9IHVzZVN0YXRlKCdJRExFJyk7CiAgICBjb25zdCBbZXhwbGFuYXRpb24sIHNldEV4cGxhbmF0aW9uXSA9IHVzZVN0YXRlKCdFbnRlciBhIHByb21wdCBhbmQgSVwnbGwgY3JlYXRlIGEgdm9pY2UtbGVkIHZpc3VhbCBleHBsYW5hdGlvbiBmb3IgeW91LicpOwogICAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZShudWxsKTsKICAgIGNvbnN0IFt3aGl0ZWJvYXJkU3RlcHMsIHNldFdoaXRlYm9hcmRTdGVwc10gPSB1c2VTdGF0ZShbXSk7CiAgICBjb25zdCBbY3VycmVudFN0ZXBJbmRleCwgc2V0Q3VycmVudFN0ZXBJbmRleF0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtjYW52YXNLZXksIHNldENhbnZhc0tleV0gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IFtpc1BhdXNlZCwgc2V0SXNQYXVzZWRdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgLy8gLS0tIEF1ZGlvICYgQW5pbWF0aW9uIEVuZ2luZSBSZWZzIC0tLQogICAgY29uc3QgYXVkaW9Db250ZXh0UmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3QgYXVkaW9Xb3JrZXJSZWYgPSB1c2VSZWYobnVsbCk7CiAgICBjb25zdCBhdWRpb1NvdXJjZVJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGF1ZGlvQnVmZmVyc1JlZiA9IHVzZVJlZihbXSk7CiAgICBjb25zdCBzdGVwVGltZW91dFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZiA9IHVzZVJlZihudWxsKTsKICAgIGNvbnN0IGFuaW1hdGlvbkZyYW1lUmVmID0gdXNlUmVmKG51bGwpOwogICAgY29uc3Qgb3ZlcmFsbEV4cGxhbmF0aW9uUmVmID0gdXNlUmVmKCcnKTsKICAgIGNvbnN0IHBsYXliYWNrT2Zmc2V0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3Qgc3RhcnRlZEF0UmVmID0gdXNlUmVmKDApOwogICAgY29uc3QgW2FuaW1hdGlvblByb2dyZXNzLCBzZXRBbmltYXRpb25Qcm9ncmVzc10gPSB1c2VTdGF0ZSgwKTsKICAgIGNvbnN0IHN0b3BFdmVyeXRoaW5nID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RlcFRpbWVvdXRSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KQogICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7IC8qIGlnbm9yZSAqLyB9CiAgICAgICAgICAgIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzZXRJc1BhdXNlZChmYWxzZSk7CiAgICAgICAgcGxheWJhY2tPZmZzZXRSZWYuY3VycmVudCA9IDA7CiAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICB9LCBbXSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBhdWRpb0NvbnRleHRSZWYuY3VycmVudCA9IG5ldyAod2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0KSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2F1ZGlvV29ya2VyQ29kZV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnIH0pOwogICAgICAgIGNvbnN0IHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CiAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudCA9IHdvcmtlcjsKICAgICAgICB3b3JrZXIub25tZXNzYWdlID0gKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgeyBjaGFubmVscywgZnJhbWVDb3VudCwgc2FtcGxlUmF0ZSwgaW5kZXggfSA9IGUuZGF0YTsKICAgICAgICAgICAgaWYgKCFhdWRpb0NvbnRleHRSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhdWRpb0NvbnRleHRSZWYuY3VycmVudC5jcmVhdGVCdWZmZXIoY2hhbm5lbHMubGVuZ3RoLCBmcmFtZUNvdW50LCBzYW1wbGVSYXRlKTsKICAgICAgICAgICAgY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbERhdGEsIGkpID0+IHsKICAgICAgICAgICAgICAgIGF1ZGlvQnVmZmVyLmdldENoYW5uZWxEYXRhKGkpLnNldChjaGFubmVsRGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtpbmRleF0gPSBhdWRpb0J1ZmZlcjsKICAgICAgICB9OwogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIHdvcmtlci50ZXJtaW5hdGUoKTsKICAgICAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICAgICAgYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQ/LmNsb3NlKCk7CiAgICAgICAgfTsKICAgIH0sIFtzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gdXNlQ2FsbGJhY2soYXN5bmMgKHByb21wdCkgPT4gewogICAgICAgIGlmICghcHJvbXB0LnRyaW0oKSB8fCBzdGF0dXMgPT09ICdUSElOS0lORycgfHwgc3RhdHVzID09PSAnUFJFUEFSSU5HJykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudD8uc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB7CiAgICAgICAgICAgIGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LnJlc3VtZSgpOwogICAgICAgIH0KICAgICAgICBzdG9wRXZlcnl0aGluZygpOwogICAgICAgIHNldFN0YXR1cygnVEhJTktJTkcnKTsKICAgICAgICBzZXRFcnJvcihudWxsKTsKICAgICAgICBzZXRXaGl0ZWJvYXJkU3RlcHMoW10pOwogICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoMCk7CiAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBbXTsKICAgICAgICBzZXRDYW52YXNLZXkocHJldiA9PiBwcmV2ICsgMSk7CiAgICAgICAgbGV0IG1zZ0luZGV4ID0gMDsKICAgICAgICBzZXRFeHBsYW5hdGlvbihUSElOS0lOR19NRVNTQUdFU1ttc2dJbmRleF0pOwogICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgbXNnSW5kZXggPSAobXNnSW5kZXggKyAxKSAlIFRISU5LSU5HX01FU1NBR0VTLmxlbmd0aDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oVEhJTktJTkdfTUVTU0FHRVNbbXNnSW5kZXhdKTsKICAgICAgICB9LCAyNTAwKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEluaXRpYWxQbGFuKHByb21wdCk7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAvLyAtLS0gREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBjb25zdCBpc1BvaW50T2JqZWN0ID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBBYnNvbHV0ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnggPT09ICdudW1iZXInICYmIHR5cGVvZiBwLnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBSZWxhdGl2ZSBwb2ludCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLnJlZmVyZW5jZUNpcmNsZUlkMSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHAucmVmZXJlbmNlQ2lyY2xlSWQyID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgcC5pbnRlcnNlY3Rpb25JbmRleCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCFyZXNwb25zZSB8fCB0eXBlb2YgcmVzcG9uc2UuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnIHx8ICFBcnJheS5pc0FycmF5KHJlc3BvbnNlLndoaXRlYm9hcmQpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBBSSByZXR1cm5lZCBhbiBpbnZhbGlkIHBsYW4gc3RydWN0dXJlLiBQbGVhc2UgdHJ5IHJlcGhyYXNpbmcgeW91ciBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3BvbnNlLndoaXRlYm9hcmQubGVuZ3RoID09PSAwICYmICFyZXNwb25zZS5leHBsYW5hdGlvbikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgQUkgcmV0dXJuZWQgYW4gZW1wdHkgcGxhbi4gUGxlYXNlIHRyeSBhIGRpZmZlcmVudCBwcm9tcHQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgc3RlcF0gb2YgcmVzcG9uc2Uud2hpdGVib2FyZC5lbnRyaWVzKCkpIHsKICAgICAgICAgICAgICAgIGlmICghc3RlcCB8fCB0eXBlb2Ygc3RlcC5vcmlnaW4/LnggIT09ICdudW1iZXInIHx8IHR5cGVvZiBzdGVwLm9yaWdpbj8ueSAhPT0gJ251bWJlcicgfHwgdHlwZW9mIHN0ZXAuZXhwbGFuYXRpb24gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwICR7aSArIDF9IGlzIG1hbGZvcm1lZCAobWlzc2luZyBvcmlnaW4gb3IgZXhwbGFuYXRpb24pLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgYWxsSXRlbXMgPSBbLi4uKHN0ZXAuZHJhd2luZ1BsYW4gfHwgW10pLCAuLi4oc3RlcC5hbm5vdGF0aW9ucyB8fCBbXSldOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBbaiwgaXRlbV0gb2YgYWxsSXRlbXMuZW50cmllcygpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpdGVtIHx8ICFpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gaXMgbWlzc2luZyBhICd0eXBlJy5gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChpdGVtLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmVjdGFuZ2xlJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY21kID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuY2VudGVyKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnY2VudGVyJyBpbiAncmVjdGFuZ2xlJyBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjaXJjbGUnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5jZW50ZXIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBvciBtaXNzaW5nICdjZW50ZXInIGluICdjaXJjbGUnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5wb2ludCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3BvaW50JyBpbiAndGV4dCcgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYXJyb3cnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1BvaW50T2JqZWN0KGNtZC5zdGFydCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG9yIG1pc3NpbmcgJ3N0YXJ0JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChjbWQuZW5kKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3IgbWlzc2luZyAnZW5kJyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbWQuY29udHJvbFBvaW50ICYmICFpc1BvaW50T2JqZWN0KGNtZC5jb250cm9sUG9pbnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCAnY29udHJvbFBvaW50JyBpbiAnYXJyb3cnIEl0ZW0gJHtqICsgMX0sIFN0ZXAgJHtpICsgMX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhdGgnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNtZC5wb2ludHMpIHx8IGNtZC5wb2ludHMubGVuZ3RoIDwgMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdwYXRoJyBhdCBJdGVtICR7aiArIDF9IGluIFN0ZXAgJHtpICsgMX0gbXVzdCBoYXZlIGEgJ3BvaW50cycgYXJyYXkgd2l0aCBhdCBsZWFzdCB0d28gcG9pbnRzLmApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIGNtZC5wb2ludHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUG9pbnRPYmplY3QocCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwb2ludCBpbiAncG9pbnRzJyBhcnJheSBmb3IgSXRlbSAke2ogKyAxfSwgU3RlcCAke2kgKyAxfWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaWtldGhyb3VnaCc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IGl0ZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY21kLnBvaW50cykgfHwgY21kLnBvaW50cy5sZW5ndGggPCAyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJ3N0cmlrZXRocm91Z2gnIGF0IEl0ZW0gJHtqICsgMX0gaW4gU3RlcCAke2kgKyAxfSBtdXN0IGhhdmUgYSAncG9pbnRzJyBhcnJheSB3aXRoIGF0IGxlYXN0IHR3byBwb2ludHMuYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgY21kLnBvaW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNQb2ludE9iamVjdChwKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBvaW50IGluICdwb2ludHMnIGFycmF5IGZvciBJdGVtICR7aiArIDF9LCBTdGVwICR7aSArIDF9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIC0tLSBFTkQgREVFUCBWQUxJREFUSU9OIExPR0lDIC0tLQogICAgICAgICAgICBpZiAocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNldFN0YXR1cygnRE9ORScpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFN0YXR1cygnUFJFUEFSSU5HJyk7CiAgICAgICAgICAgIG1zZ0luZGV4ID0gMDsKICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50ID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgICAgIG1zZ0luZGV4ID0gKG1zZ0luZGV4ICsgMSkgJSBQUkVQQVJJTkdfTUVTU0FHRVMubGVuZ3RoOwogICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24oUFJFUEFSSU5HX01FU1NBR0VTW21zZ0luZGV4XSk7CiAgICAgICAgICAgIH0sIDI1MDApOwogICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwMCkpOwogICAgICAgICAgICBpZiAoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpCiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHN0YXR1c01lc3NhZ2VJbnRlcnZhbFJlZi5jdXJyZW50KTsKICAgICAgICAgICAgYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnQgPSBuZXcgQXJyYXkocmVzcG9uc2Uud2hpdGVib2FyZC5sZW5ndGgpLmZpbGwobnVsbCk7CiAgICAgICAgICAgIG92ZXJhbGxFeHBsYW5hdGlvblJlZi5jdXJyZW50ID0gcmVzcG9uc2UuZXhwbGFuYXRpb247CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKHJlc3BvbnNlLmV4cGxhbmF0aW9uKTsKICAgICAgICAgICAgc2V0V2hpdGVib2FyZFN0ZXBzKHJlc3BvbnNlLndoaXRlYm9hcmQpOwogICAgICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgIGlmIChzdGF0dXNNZXNzYWdlSW50ZXJ2YWxSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3RhdHVzTWVzc2FnZUludGVydmFsUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuJzsKICAgICAgICAgICAgc2V0RXJyb3IoYFNvcnJ5LCBJIGNvdWxkbid0IHByb2Nlc3MgdGhhdC4gJHtlcnJvck1lc3NhZ2V9YCk7CiAgICAgICAgICAgIHNldEV4cGxhbmF0aW9uKCdPb3BzISBTb21ldGhpbmcgd2VudCB3cm9uZy4gVGhlIGRyYXdpbmcgYXNzaXN0YW50IGVuY291bnRlcmVkIGFuIHVuZXhwZWN0ZWQgZXJyb3IuJyk7CiAgICAgICAgICAgIHNldFN0YXR1cygnRVJST1InKTsKICAgICAgICB9CiAgICB9LCBbc3RhdHVzLCBzdG9wRXZlcnl0aGluZ10pOwogICAgY29uc3QgaGFuZGxlUmVwZWF0ID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIGlmICh3aGl0ZWJvYXJkU3RlcHMubGVuZ3RoID09PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgc3RvcEV2ZXJ5dGhpbmcoKTsKICAgICAgICBzZXRDdXJyZW50U3RlcEluZGV4KDApOwogICAgICAgIHNldENhbnZhc0tleShwcmV2ID0+IHByZXYgKyAxKTsKICAgICAgICBzZXRTdGF0dXMoJ0RSQVdJTkcnKTsKICAgIH0sIFt3aGl0ZWJvYXJkU3RlcHMsIHN0b3BFdmVyeXRoaW5nXSk7CiAgICBjb25zdCBoYW5kbGVUb2dnbGVQYXVzZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICBpZiAoc3RhdHVzID09PSAnRFJBV0lORycpIHsKICAgICAgICAgICAgc2V0SXNQYXVzZWQocCA9PiAhcCk7CiAgICAgICAgfQogICAgfSwgW3N0YXR1c10pOwogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ID0gMDsKICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygwKTsKICAgIH0sIFtjdXJyZW50U3RlcEluZGV4XSk7CiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IGN1cnJlbnRTdGVwID0gd2hpdGVib2FyZFN0ZXBzW2N1cnJlbnRTdGVwSW5kZXhdOwogICAgICAgIGlmIChzdGF0dXMgIT09ICdEUkFXSU5HJyB8fCAhY3VycmVudFN0ZXAgfHwgaXNQYXVzZWQpIHsKICAgICAgICAgICAgaWYgKGF1ZGlvU291cmNlUmVmLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudC5zdG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgICAgICBhdWRpb1NvdXJjZVJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50ICs9IGVsYXBzZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgaXNDYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICBzZXRFeHBsYW5hdGlvbihjdXJyZW50U3RlcC5leHBsYW5hdGlvbik7CiAgICAgICAgaWYgKHBsYXliYWNrT2Zmc2V0UmVmLmN1cnJlbnQgPT09IDApIHsKICAgICAgICAgICAgc2V0QW5pbWF0aW9uUHJvZ3Jlc3MoMCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBsZXRlQW5kQWR2YW5jZSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCkKICAgICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lUmVmLmN1cnJlbnQpOwogICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcygxKTsKICAgICAgICAgICAgc3RlcFRpbWVvdXRSZWYuY3VycmVudCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNDYW5jZWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0ZXBJbmRleCA8IHdoaXRlYm9hcmRTdGVwcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRTdGVwSW5kZXgoaSA9PiBpICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoJ0RPTkUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0RXhwbGFuYXRpb24ob3ZlcmFsbEV4cGxhbmF0aW9uUmVmLmN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMzc1KTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHJ1blN0ZXAgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYXVkaW9CdWZmZXJzUmVmLmN1cnJlbnRbY3VycmVudFN0ZXBJbmRleF0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2U2NEF1ZGlvID0gYXdhaXQgZ2VuZXJhdGVTcGVlY2goY3VycmVudFN0ZXAuZXhwbGFuYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGJhc2U2NEF1ZGlvICYmIGF1ZGlvV29ya2VyUmVmLmN1cnJlbnQgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9Xb3JrZXJSZWYuY3VycmVudC5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2U2NEF1ZGlvLCBzYW1wbGVSYXRlOiAyNDAwMCwgbnVtQ2hhbm5lbHM6IDEsIGluZGV4OiBjdXJyZW50U3RlcEluZGV4CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IGF1ZGlvQnVmZmVyc1JlZi5jdXJyZW50W2N1cnJlbnRTdGVwSW5kZXhdIHx8IG51bGw7CiAgICAgICAgICAgIGxldCB3YWl0Q291bnQgPSAwOwogICAgICAgICAgICB3aGlsZSAoIWJ1ZmZlciAmJiB3YWl0Q291bnQgPCAxMDAgJiYgIWlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTAwKSk7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBhdWRpb0J1ZmZlcnNSZWYuY3VycmVudFtjdXJyZW50U3RlcEluZGV4XSB8fCBudWxsOwogICAgICAgICAgICAgICAgd2FpdENvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBvZmZzZXRTZWMgPSBwbGF5YmFja09mZnNldFJlZi5jdXJyZW50OwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbk1zID0gYnVmZmVyID8gKGJ1ZmZlci5kdXJhdGlvbiAtIG9mZnNldFNlYykgKiAxMDAwIDogNDAwMDsKICAgICAgICAgICAgY29uc3Qgc3RlcFN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgICBjb25zdCBhbmltYXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGlzQ2FuY2VsbGVkKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UHJvZ3Jlc3MgPSAwOwogICAgICAgICAgICAgICAgaWYgKGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50ICYmIGF1ZGlvU291cmNlUmVmLmN1cnJlbnQ/LmJ1ZmZlciAmJiBzdGFydGVkQXRSZWYuY3VycmVudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkU2VjID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWUgLSBzdGFydGVkQXRSZWYuY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbFBsYXllZFNlYyA9IG9mZnNldFNlYyArIGVsYXBzZWRTZWM7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4odG90YWxQbGF5ZWRTZWMgLyBhdWRpb1NvdXJjZVJlZi5jdXJyZW50LmJ1ZmZlci5kdXJhdGlvbiwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkTXMgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0ZXBTdGFydFRpbWU7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFByb2dyZXNzID0gTWF0aC5taW4oZWxhcHNlZE1zIC8gZHVyYXRpb25NcywgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRBbmltYXRpb25Qcm9ncmVzcyhjdXJyZW50UHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQcm9ncmVzcyA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICAgICAgICBzdGVwVGltZW91dFJlZi5jdXJyZW50ID0gd2luZG93LnNldFRpbWVvdXQoY29tcGxldGVBbmRBZHZhbmNlLCBkdXJhdGlvbk1zICsgMTAwKTsKICAgICAgICAgICAgaWYgKGJ1ZmZlciAmJiBhdWRpb0NvbnRleHRSZWYuY3VycmVudCAmJiBvZmZzZXRTZWMgPCBidWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgIHNvdXJjZS5jb25uZWN0KGF1ZGlvQ29udGV4dFJlZi5jdXJyZW50LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwLCBvZmZzZXRTZWMpOwogICAgICAgICAgICAgICAgYXVkaW9Tb3VyY2VSZWYuY3VycmVudCA9IHNvdXJjZTsKICAgICAgICAgICAgICAgIHN0YXJ0ZWRBdFJlZi5jdXJyZW50ID0gYXVkaW9Db250ZXh0UmVmLmN1cnJlbnQuY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJ1blN0ZXAoKTsKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBpc0NhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChhbmltYXRpb25GcmFtZVJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChzdGVwVGltZW91dFJlZi5jdXJyZW50KQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHN0ZXBUaW1lb3V0UmVmLmN1cnJlbnQpOwogICAgICAgIH07CiAgICB9LCBbc3RhdHVzLCBjdXJyZW50U3RlcEluZGV4LCB3aGl0ZWJvYXJkU3RlcHMsIGlzUGF1c2VkXSk7CiAgICByZXR1cm4gKF9qc3hzKCJkaXYiLCB7IGNsYXNzTmFtZTogInctc2NyZWVuIGgtc2NyZWVuIGJnLWJsYWNrIHRleHQtd2hpdGUgZm9udC1zYW5zIGZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktY2VudGVyIHJlbGF0aXZlIiwgY2hpbGRyZW46IFtfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJhYnNvbHV0ZSB0b3AtMCBsZWZ0LTAgcmlnaHQtMCBwLTQgZmxleCBqdXN0aWZ5LWJldHdlZW4gaXRlbXMtY2VudGVyIHotMTAgcG9pbnRlci1ldmVudHMtbm9uZSIsIGNoaWxkcmVuOiBbX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJwb2ludGVyLWV2ZW50cy1hdXRvIiwgY2hpbGRyZW46IF9qc3goTG9nb0ljb24sIHsgY2xhc3NOYW1lOiAiaC04IHctYXV0byIgfSkgfSksIF9qc3goImRpdiIsIHsgY2xhc3NOYW1lOiAicG9pbnRlci1ldmVudHMtYXV0byIsIGNoaWxkcmVuOiBfanN4cygiZGl2IiwgeyBjbGFzc05hbWU6ICJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtNCBiZy13aGl0ZS81IGJhY2tkcm9wLWJsdXIteGwgYm9yZGVyIGJvcmRlci13aGl0ZS8xMCByb3VuZGVkLWZ1bGwgcHgtNCBweS0xLjUgdGV4dC1zbSB0ZXh0LWdyYXktNTAwIHNoYWRvdy1sZyIsIGNoaWxkcmVuOiBbX2pzeCgic3BhbiIsIHsgY2hpbGRyZW46ICJSZXNlYXJjaCBQcmV2aWV3IiB9KSwgX2pzeCgiZGl2IiwgeyBjbGFzc05hbWU6ICJ3LXB4IGgtNCBiZy13aGl0ZS8yMCIgfSksIF9qc3goImEiLCB7IGhyZWY6ICJtYWlsdG86YWktZHJhd2luZy1hc3Npc3RhbnQtZmVlZGJhY2tAZ29vZ2xlLmNvbSIsIHRhcmdldDogIl9ibGFuayIsIHJlbDogIm5vb3BlbmVyIG5vcmVmZXJyZXIiLCB0aXRsZTogIkVtYWlsIFVzIiwgY2xhc3NOYW1lOiAidGV4dC1ncmF5LTQwMCBob3Zlcjp0ZXh0LWN5YW4tNDAwIHRyYW5zaXRpb24tYWxsIGR1cmF0aW9uLTMwMCBob3Zlcjpkcm9wLXNoYWRvdy1bMF8wXzRweF9yZ2JhKDM0LDIxMSwyMzgsMC44KV0iLCBjaGlsZHJlbjogX2pzeChNYWlsSWNvbiwgeyBjbGFzc05hbWU6ICJ3LTUgaC01IiB9KSB9KSwgX2pzeCgiYSIsIHsgaHJlZjogImh0dHBzOi8vZ2l0aHViLmNvbS9nb29nbGUvYWlzdHVkaW8td2ViIiwgdGFyZ2V0OiAiX2JsYW5rIiwgcmVsOiAibm9vcGVuZXIgbm9yZWZlcnJlciIsIHRpdGxlOiAiVmlldyBvbiBHaXRIdWIiLCBjbGFzc05hbWU6ICJ0ZXh0LWdyYXktNDAwIGhvdmVyOnRleHQtd2hpdGUgdHJhbnNpdGlvbi1hbGwgZHVyYXRpb24tMzAwIGhvdmVyOmRyb3Atc2hhZG93LVswXzBfNHB4X3JnYmEoMjU1LDI1NSwyNTUsMC44KV0iLCBjaGlsZHJlbjogX2pzeChHaXRodWJJY29uLCB7IGNsYXNzTmFtZTogInctNSBoLTUiIH0pIH0pXSB9KSB9KV0gfSksIF9qc3goQ2FudmFzLCB7IHN0ZXBzOiB3aGl0ZWJvYXJkU3RlcHMsIGN1cnJlbnRTdGVwSW5kZXg6IGN1cnJlbnRTdGVwSW5kZXgsIHN0YXR1czogc3RhdHVzLCBhbmltYXRpb25Qcm9ncmVzczogYW5pbWF0aW9uUHJvZ3Jlc3MsIGlzUGF1c2VkOiBpc1BhdXNlZCwgZXhwbGFuYXRpb246IGV4cGxhbmF0aW9uIH0sIGNhbnZhc0tleSksIF9qc3goQ29udHJvbHMsIHsgc3RhdHVzOiBzdGF0dXMsIGV4cGxhbmF0aW9uOiBleHBsYW5hdGlvbiwgZXJyb3I6IGVycm9yLCBzdGVwczogd2hpdGVib2FyZFN0ZXBzLCBjdXJyZW50U3RlcEluZGV4OiBjdXJyZW50U3RlcEluZGV4LCBpc1BhdXNlZDogaXNQYXVzZWQsIG9uU3VibWl0OiBoYW5kbGVTdWJtaXQsIG9uUmVwZWF0OiBoYW5kbGVSZXBlYXQsIG9uVG9nZ2xlUGF1c2U6IGhhbmRsZVRvZ2dsZVBhdXNlIH0pXSB9KSk7Cn07CmV4cG9ydCBkZWZhdWx0IEFwcDsK:248
